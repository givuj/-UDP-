# UDP 通信与可靠UDP实现笔记


## 一、UDP基础知识点
---
1. 核心特性：UDP是以**包的形式**传播数据
2. 阻塞状态与CPU优化：
   程序等待数据时会进入阻塞状态（如`recvfrom(1024)`），此时CPU会切换到其他进程/线程（减少CPU占用），但也会导致程序无法响应系统命令（如`ctrl+c`停止程序）
3. 数据包内存限制：
   数据包先存入内存，操作系统通知CPU处理；`recvfrom(1024)`单次最多读取1024字节，超出部分会被舍弃，需通过`while true`循环重复提取
4. `select`优化阻塞问题：
   阻塞时无法主动结束进程，需等超时；用`select`优化后：
   - 支持监听`ctrl+c`信号，可立即终止程序
   - 具备「可中断等待」「多socket监听」能力，底层依赖**IO多路复用**


## 二、实现“可靠UDP”
---

### 1. 服务器端核心逻辑
- 初始化：绑定端口，通过`select`实现1秒轮询（无僵死阻塞、支持中断）
- 数据包解析：校验`DATA|序列号|消息`格式，过滤无效包
- 去重处理：用`processed_seq`集合存储已处理序列号，避免重复消费
- ACK回复：合法未重复包，返回`ACK|序列号|确认包`
- 模拟丢包（测试）：通过`random`概率丢弃数据包，验证重传逻辑
- 优雅退出：`select`监听信号，`Ctrl+C`可立即响应（无需等超时）


### 2. 客户端核心逻辑
- 超时重传：配置超时时间（如3秒）+最大重试次数（如3次），未收ACK则重传
- 序列号管理：全局维护`current_seq`，每发一个包自增，保证唯一性
- ACK校验：解析服务器ACK包，仅当序列号与发送包一致时，确认发送成功
- 异常处理：适配Windows「端口不可达」错误（10054），需保证**客户端/服务器端口一致、服务器先启动**


### 3. 主要解决的问题
- 丢包问题：网络波动/服务器延迟导致的数据包丢失（原逻辑客户端无感知）
- 重复问题：网络延迟引发客户端重传，导致服务器收到重复包
- 无确认机制：原逻辑客户端无法确认服务器是否收到数据
